# GitHub 针对 AWS CDK 自动化 CI/CD 部署的行动

> 原文：<https://www.gitkraken.com/gitkon/aws-cdk-github-actions-ci-cd-deployment>

[https://www.youtube.com/embed/ah2X8689ny8?feature=oembed](https://www.youtube.com/embed/ah2X8689ny8?feature=oembed)

视频

开发人员都必须处理部署。您可以手动处理这些问题，也可以通过 CI/CD 自动化来解决。大多数开发人员和组织从手动部署开始。然而，手动部署可能是一个痛苦的过程。这些棘手问题分为几个类别。

## **手动部署的痛苦**

首先，手动部署通常意味着部署不一致。不一致地一次发布许多变更，而不是不断地部署较小的提交，会使回滚成为非常痛苦的经历。它还引入了文件有时被遗忘的风险，或者甚至应用程序的整个部分被放弃。

手动进行部署通常也意味着较少的测试。由于测试也是手动的，因此在推向生产之前，很可能不会在所有特性上统一进行测试。

环境之间的功能滞后是手动部署的另一个常见陷阱。由于生产环境配置落后于开发环境，开发团队必须考虑不断增长的相关问题。这导致开发周期越来越长。如果部署是痛苦的，许多人会尝试拖延，直到有更多的部署或者事情更完整。

最后，手动部署需要一定的部落知识。如果只有少数人或特定的个人知道如何在您的环境中成功部署，那么员工流动将成为更具破坏性的事件。管理部署的团队越小，通常意味着许多小步骤不会被记录，只有那些团队成员知道。当一个人离开公司，或者他们正在度假，而其他人需要部署时，只有到那时，您才发现信息丢失了，这可能导致部署失败。

## **自动化 CI/CD 的优势**

在部署范围的另一端，您拥有完全自动化的 CI/CD 部署。这种方法有利于提高生产时间和代码质量。这也为每个团队成员和整个团队带来了好处。

对于开发人员来说，自动化部署带来了一键式开发环境设置。当引入新的开发人员或替换旧的开发环境时，您可以使用一个命令启动新的环境，从而更快地开发新的功能和改进。

自动化环境构建步骤也允许您自动化测试。每一次提交都可以触发构建过程，并自动运行任何已定义的测试。然后，该流程的日志和输出就变成了只有在某些东西失败时才需要查看的东西，而不是用于执行手动测试的 UI。

自动化部署和相关的自动构建步骤带来了跨环境的更大一致性。保持开发、测试、试运行和生产环境的一致性为开发人员省去很多麻烦。一致性给开发者信心；如果代码和配置在一个环境中工作，那么它也应该在生产环境中工作。

自动化 CI/CD 部署带来了外部化的配置。什么是外部化配置？当您的推送发生时，系统可以从秘密管理器或代码库之外的其他地方获取特定环境所需的规范和秘密。这使开发人员不必担心代码中包含的配置，并且可以将您从关注特性中解放出来，而不是手动处理部署细节。

这种方法将基础设施作为代码。自动化流程和所需的基础设施意味着您很可能将配置作为代码库的一部分来维护。任何人都可以看到代码库，包括审计员和经理，这使得自动测试每个设置更加容易。它还允许您轻松地对 CI/CD 流程进行版本控制。

这种方法的另一个好处是，它允许您将自动触发器添加到流程中，一直到生产。例如，当您提交代码、创建新标签或创建新版本时，自动触发器就会触发。每个动作都可以触发一个特定环境的推送，或者启动一组测试。

如果您对优化您的工作流和 Git 中项目合作者的系统化流程感兴趣，GitKraken 将帮助您更快地执行操作，提供更多的控制和更少的上下文切换。

## **光盘行业的现状**

86%的组织表示速度对他们的应用程序至关重要。对于他们的业务来说，速度和能够以更快的方式做事至关重要。然而，只有 77%的公司实际上在使用 DevOps 并实现自动化。77%的人说他们正在使用它，只有 10%的人说他们成功了。

那么为什么不是每个人都在做，而且做得很成功呢？在使用 DevOps 的公司中，49%的公司认为遗留应用程序及其遗留代码库和流程是采用更好的 DevOps 实践的最大挑战。在同一组中，71%的人说他们使用容器。这并不意味着他们只使用*的*容器，只是他们使用容器作为他们 DevOps 策略的一部分。在 CapitalOne 上可以看到一些真实世界中的例子，它每天部署大约 50 次。另一方面，在极端规模下，像亚马逊、谷歌和网飞这样的公司每天部署数千次。如果没有自动化，这些公司将无法以这样的频率进行部署。但是，他们如何着手自动化他们的 CI/CD 流程呢？

## **自动化 CI/CD 的 GitHub 动作**

一种自动化 CI/CD 的方法是利用 [GitHub Actions](https://github.com/features/actions) ，这给了开发者自动化你的工作流程的机会，从想法到生产。好的一面是，完成 GitHub 动作所需的所有代码都在 GitHub 的代码库中。GitHub Actions 非常容易使用，并且走上了自动化的道路。它还为您提供了一条通往基础设施和代码的便捷之路。

GitHub 操作是基于项目的，这意味着创建的工作流的配置存储在单独的项目报告中。这减少了任何给定工作流需要管理的文件和流程的数量。GitHub Actions 中也有一个非常方便的市场。如果你担心开始，公司和个人开发人员已经分享了他们的工作流程，这提供了一个快速启动和工作的快速方法。很有可能已经有与你想做的事情相关的东西了。

GitHub 动作有助于在所有环境中实现一致性。无论是开发、测试还是生产，或者需要什么依赖关系，自动化过程都可以很容易地被监控和调整。这也意味着执行需要人工干预的事情，如[代码审查](https://www.gitkraken.com/blog/code-review)，执行 [Git 分支策略](https://www.gitkraken.com/learn/git/best-practices/git-branch-strategy)，以及处理问题，都可以在 GitHub 的单一平台中完成。

GitKraken 强大的 GitHub 集成使您能够通过 GitHub 操作自动化 Git 工作流程！直接在 Git 客户端中轻松创建和编辑 GitHub 操作工作流。

## **亚马逊弹性容器服务(AWS ECS)**

工作流程中要考虑的下一件事是生产方面的事情。亚马逊的弹性容器服务(AWS ECS)让用户能够管理亚马逊上的容器，并在其中部署代码。像亚马逊的大多数东西一样，AWS ECS 的好处是安全性是“零工作”。他们确实在 ECS 的安全性方面花了很多心思，并使将安全规则添加到您的工作流程中变得很容易。

AWS ECS 是完全托管的，这意味着您不必担心管理容器背后的基础设施。你所需要做的就是使用容器，让 Amazon 处理它的后端。作为一种容器编排服务，它为您省去许多繁重的工作。

AWS ECS 与大多数其他 AWS 服务集成，如 [AWS 身份&访问管理](https://aws.amazon.com/iam/)和[亚马逊 S3](https://aws.amazon.com/s3/) ，让您在容器中使用所有这些服务。在亚马逊上没有服务器通常意味着利用[亚马逊 Fargate](https://aws.amazon.com/fargate/) 。所有这些服务都有助于快速轻松地部署和扩展所有类型的应用程序。

## **亚马逊云开发套件(AWS CDK)**

AWS ECS 所有自动化的核心是[亚马逊云开发套件](https://aws.amazon.com/cdk/) (AWS CDK)。CDK 基本上是作为代码的基础设施的核心，它为您提供了一种创建代码的方式来构建和提升您的基础设施。它是开源的，在 GitHub 上有[。它允许您使用自己选择的编程语言进行构建，比如 JavaScript、TypeScript、Python、Java、C#、甚至 GoLang。](https://github.com/aws/aws-cdk)

由于亚马逊 CDK 基于您的代码进行调用，甚至这部分工作流程也可以使用版本控制进行跟踪。当您添加或更改内容时，您会在源代码控制中跟踪这些更改。您还可以测试进行这些调用的代码，就像您测试用您喜欢的编程语言编写的任何其他代码一样。

AWS CDK 还有一个方便的命令行界面。您可以直接访问系统并运行许多不同的命令，如`deploy`、`destroy`和`doctor`。

GitKraken CLI 提供了 Git 增强的终端体验，具有强大的功能，如 Git 命令的自动完成和自动建议、CLI 差异视图等。

## **亚马逊代码构建**

[Amazon CodeBuild](https://aws.amazon.com/codebuild/) 是代码管道的一部分，用于构建将与 AWS CDK 一起部署的包。CodeBuild 编译源代码，并准备好发布和部署到某个地方，将它生成的工件作为归档交付给您，以便于存储和传输。也可以设置 CodeBuild 来运行您的测试。

与许多其他亚马逊服务一样，CodeBuild 非常具有可扩展性。它允许您从应用程序中创建多个构建。您可以根据需要创建任意多的构建，也可以让它们同时运行，这通常是大型项目所需要的。

CodeBuild 是完全可定制的。由于您可以添加任何所需的自定义代码，因此您的部署的每一部分都可以根据您的确切需求进行定制。

## **用 GitHub 动作把它们绑在一起**

那么，我们如何从将代码推送到 GitHub，到在 AWS 上使用 CodeBuild 进行构建呢？[点击这里](https://youtu.be/ah2X8689ny8?t=1065)观看一个使用 GitHub 库的例子，[社交拯救者](https://github.com/adamculp/social-saver/actions)。

在每个 GitHub repo 中，你都可以找到一个 GitHub Actions 标签页。在您的任何存储库上打开此选项卡，您只需单击一个按钮即可开始设置您的工作流。你还会看到一个市场就在你的指尖。你可以通过 GitHub.com 的界面完成所有需要的设置。该服务在您的存储库中为您创建一个文件，因为 GitHub 操作是 repo 特定的。

您可以利用 GitHub Actions marketplace 中的工作流模板。这些预先制作的模板可以与任何 AWS 服务进行交互，以部署到 Amazon ECS。如果您想使用 GitHub Actions 做任何事情，可能会有一个由公司或个人创建的模板供您使用。

从市场中选择一个模板将在您的代码库中的`.github`目录下创建工作流文件。在该文件夹中，您将找到一个 `workflows`子目录，您将在其中保存您的工作流。工作流以`.yml`文件的形式存在，是版本控制存储库的一部分。

在工作流的`.yml`文件中，您定义了工作流所需的元素。首先是事件的触发器，从像`on:`这样的东西开始。`.yml`文件还定义了工作流应该部署的环境。在声明触发事件和目标之后，您需要定义操作步骤。这些步骤可以定义诸如签出代码、配置 AWS 凭证、登录 Amazon ECS 以及完成工作流所需的任何事情。

你可以也应该为你正在使用的任何服务使用一个秘密管理器。您不必将您的秘密和密钥直接添加到代码中，而是声明秘密存储的位置。在这种情况下，它们被安全地存储在 AWS 的安全层之后。

## **声明任务定义**

完成这个工作流还需要 Amazon CodeBuild 的任务定义。这一点非常重要，因为`task-definition.json`文件定义了如何设置工作流程。这超出了您的`.yml`文件中的工作流程中的步骤。这些任务定义创建资源和所需容器的名称，设置端口映射，定义要使用的机器映像，以及其他类似的事情。

当 Amazon CodeBuild 运行时，您应该得到一个 AWS ECS 集群，它实现了您指定的所有细节和测试定义。如果你想使用 Kubernetes 而不是 Amazon 风格的容器，你可以定义它来实现。同样，每个细节和选项都是完全可定制的。与此同时，GitHub 正在等待构建过程的结果。一切执行完毕后，GitHub 工作流会更新，告诉你事情进展如何。如果您看到绿色复选标记，那么您知道事情按预期进行。您可以单击这些复选标记来查看流程任何部分的详细信息。日志记录非常深入，显示了每个单独步骤的细节。

## **开始使用 GitHub Actions 和 AWS CDK**

[观看此视频](https://youtu.be/ah2X8689ny8)，了解 Learning A-Z 的高级首席软件架构师 Adam Culp 如何利用 GitHub Actions 和 AWS CDK 从 GitHub 部署到 AWS 的示例，以及 2021 年 [GitKon Git 大会的现场问答](https://gitkon.com/)！