# 使用 Cloudflare CDN 节省带宽(和资金)

> 原文：<https://www.gitkraken.com/blog/saving-bandwidth-and-money-with-cloudflare-cdn>

## 挑战

不久前，我们的产品副总裁带着一个有趣的问题来找我们。我们在一个私有的集中数据中心托管了一些服务器，这些服务器带来了大量的带宽，我们用这些带宽来托管 Git kraken Git 客户端的发布服务器。发布服务器处理客户端从我们网站的所有下载，还提供我们的客户收到的所有更新。

然而，随着我们将更多的东西转移到公共云(AWS/Azure)中，并淘汰私有数据中心的服务器，所包含的大部分带宽缩小了，不再足以满足我们的需求。支付超额费用或额外带宽过去是、现在仍然是成本高昂的。

寻找解决方案

## 我们需要一个符合以下标准的解决方案来分发我们的下载和更新:

快的

1.  便宜的
2.  无停机时间(并与现有客户端配合使用)
3.  带宽很贵

GitKraken 不是脸书，但也不小。事实上，我们最近打破了一百万用户的记录！我们的小发布服务器每天可以持续提供数 TB 的 GitKraken 下载/更新。仅通过 AWS 提供服务会让我们为带宽买单，这比我们愿意支付的要高得多。作为参考，150 TB/月的成本超过 11，500 美元。

## 不要为带宽付费

因为带宽是昂贵的，我们试图保持低成本，我们认为最好的办法是消除带宽成本。Cloudflare 不收带宽费；不管体积大小，你都不需要额外付费。此外，由于 [Cloudflare 的 CDN](https://www.cloudflare.com/cdn/) 在世界各地都有存在点(pop ),我们的发布文件可以更快地提供给客户。

避免停机

## 因为我们喜欢我们的客户成功团队，并希望避免失败下载的罚单，所以避免停机对这一过渡极其重要。我们还需要在不编辑 GitKraken 代码的情况下完成所有这些工作。因为我们的客户已经有了客户端，并且客户端知道如何以及从哪里获得它的更新，所以这个改变对于已经下载到我们客户的计算机上的 GitKraken Git 客户端来说是完全未知的。

因为带宽是昂贵的，我们试图保持低成本，我们认为最好的办法是消除带宽成本。Cloudflare 不收带宽费；不管体积大小，你都不需要额外付费。此外，由于 [Cloudflare 的 CDN](https://www.cloudflare.com/cdn/) 在世界各地都有存在点(pop ),我们的发布文件可以更快地提供给客户。

步骤 1:设置一个新域名

## 当您使用 Cloudflare 时，它实际上成为了 DNS 提供商。出于各种原因，我们不准备对整个 gitkraken.com 域这样做。相反，我们决定创建 axocdn.com 域并在 Cloudflare 上托管该域。这将允许我们快速行动，做出我们需要的更改，而不会影响我们的 DNS 和基础架构的其余部分。

因为我们喜欢我们的客户成功团队，并希望避免失败下载的罚单，所以避免停机对这一过渡极其重要。我们还需要在不编辑 GitKraken 代码的情况下完成所有这些工作。因为我们的客户已经有了客户端，并且客户端知道如何以及从哪里获得它的更新，所以这个改变对于已经下载到我们客户的计算机上的 GitKraken Git 客户端来说是完全未知的。

步骤 2:创建 AWS 基础设施

### 利用 CloudFormation，我们创建了运行发布服务器代码的必要基础设施。

当您使用 Cloudflare 时，它实际上成为了 DNS 提供商。出于各种原因，我们不准备对整个 gitkraken.com 域这样做。相反，我们决定创建 axocdn.com 域并在 Cloudflare 上托管该域。这将允许我们快速行动，做出我们需要的更改，而不会影响我们的 DNS 和基础架构的其余部分。

步骤 3:用发布文件播种新的发布服务器

### 将发布文件复制到新的发布服务器上，这样它就可以为客户端提供更新。

利用 CloudFormation，我们创建了运行发布服务器代码的必要基础设施。

步骤 4:减少 release.gitkraken.com 的 DNS TTL

### 我们想为最坏的情况做准备。如果出现问题，我们希望回滚或交换到新的服务器，我们不希望必须等待 24 小时以上才能将 DNS 更改传播到所有客户端。

第五步:翻转域名系统

我们更改了 release.gitkraken.com 的 DNS 条目，使其指向 AWS 中新创建的发布服务器，这样流量就会开始流入其中。利用 Nginx，我们将所有从 release.gitkraken.com 到新发布服务器的流量重定向回 release.axocdn.com。因为 axocdn.com 托管在 Cloudflare 之后，任何现在连接到发布服务器的用户都将访问缓存我们下载的 Cloudflare 路由。

### 步骤 4:减少 release.gitkraken.com 的 DNS TTL

步骤 6:监控性能和带宽

虽然我们运行的测试表明一切正常，但我们希望继续监控以确保一切运行顺利。在我们做出改变的最初几个小时，很大一部分请求都是发送到我们的原始服务器，这让我们有点担心。但是随着 Cloudflare 的 pop 充满了我们的下载工件，到达我们原始服务器的流量急剧下降。

### 结果呢

Cloudflare 的 CDN 将我们发布服务器的带宽减少了 100%。

从技术上讲，并不是所有的流量，但它非常接近 100%，以至于 Cloudflare 的分析仪表板将其四舍五入。实际上，Cloudflare 的 CDN 缓存了大约 99.5%的带宽。

### 我们将继续监控我们的新设置，以确保它的行为符合预期，但除了在我们创建新版本时新的更新文件必须传播到 pop 之外，我们希望流量保持在相当一致的水平。

虽然我们运行的测试表明一切正常，但我们希望继续监控以确保一切运行顺利。在我们做出改变的最初几个小时，很大一部分请求都是发送到我们的原始服务器，这让我们有点担心。但是随着 Cloudflare 的 pop 充满了我们的下载工件，到达我们原始服务器的流量急剧下降。

结果呢

## Cloudflare 的 CDN 将我们发布服务器的带宽减少了 100%。

> 从技术上讲，并不是所有的流量，但它非常接近 100%，以至于 Cloudflare 的分析仪表板将其四舍五入。实际上，Cloudflare 的 CDN 缓存了大约 99.5%的带宽。

我们将继续监控我们的新设置，以确保它的行为符合预期，但除了在我们创建新版本时新的更新文件必须传播到 pop 之外，我们希望流量保持在相当一致的水平。

We will continue to monitor our new setup to ensure it behaves as expected, but apart from new update files having to propagate out to the POPs as we create new releases, we expect traffic to remain at a fairly consistent level.